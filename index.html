<!DOCTYPE html>
<html lang="en">
<head>
    <title>Network</title>
    <script
            type="text/javascript"
            src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
    ></script>
    <style type="text/css">
        #mynetwork {
          width: 600px;
          height: 400px;
          border: 1px solid lightgray;
        }
    </style>
</head>
<body>
<div id="buttons">
    <button id="french_button" onclick="toFrench()">French</button>
    <button id="english_button" onclick="toEnglish()">English</button>
</div>
<div id="mynetwork"></div>
<div id="description" style="display:none">
    <div id="description_buttons">
        <button id="vulgarized_button" onclick="showVulgarized()">Vulgarized</button>
        <button id="definition_button" onclick="showDefinition()">Definition</button>
        <button id="details_button" onclick="showDetails()">Details</button>
        <button id="links_button" onclick="showLinks()">Links</button>
        <button id="linked_nodes_button" onclick="showLinkedNodes()">Connected to...</button>
    </div>
    <div id="description_content" style="display:block"></div>
</div>
<script type="text/javascript">

    var raw_data = [];
    var nodes = [];
    var edges = [];
    var ids = [];
    var mode = "english";
    var current_description = null;
    var current_id = null;
    var nodes_dataset = null;
    var edges_dataset = null;
    var network = null;
    var network_data = null;

    function setDescription(id) {
        var current_data = raw_data[id]
        var description_container = document.getElementById("description");
        description_container.style.display = "block";

        current_description = raw_data[id].vulgarized;
        current_id = id;

        if("vulgarized" in current_data) {
            document.getElementById("vulgarized_button").style.display = "inline-block";
            if(mode == "english") {
                document.getElementById("description_content").textContent = current_description.english;
            } else {
                document.getElementById("description_content").textContent = current_description.french;
            }
        } else {
            document.getElementById("vulgarized_button").style.display = "none";
        }

        if("definition" in current_data) {
            document.getElementById("definition_button").style.display = "inline-block";
        } else {
            document.getElementById("definition_button").style.display = "none";
        }

        if("details" in current_data) {
            document.getElementById("details_button").style.display = "inline-block";
        } else {
            document.getElementById("details_button").style.display = "none";
        }

        if("links" in current_data) {
            document.getElementById("links_button").style.display = "inline-block";
        } else {
            document.getElementById("links_button").style.display = "none";
        }

        if(current_data.edge_to.length != 0) {
            document.getElementById("linked_nodes_button").style.display = "inline-block";
        } else {
            document.getElementById("linked_nodes_button").style.display = "none";
        }
    }

    function showVulgarized() {
        if (current_description != null) {
            current_description = raw_data[current_id].vulgarized;
            if(mode == "english") {
                document.getElementById("description_content").textContent = current_description.english;
            } else {
                document.getElementById("description_content").textContent = current_description.french;
            }
        }
    }

    function showDefinition() {
        if (current_description != null) {
            current_description = raw_data[current_id].definition;
            if(mode == "english") {
                document.getElementById("description_content").textContent = current_description.english;
            } else {
                document.getElementById("description_content").textContent = current_description.french;
            }
        }
    }

    function showDetails() {
        if (current_description != null) {
            current_description = raw_data[current_id].details;
            if(mode == "english") {
                document.getElementById("description_content").textContent = current_description.english;
            } else {
                document.getElementById("description_content").textContent = current_description.french;
            }
        }
    }

    function showLinks() {
        if (current_description != null) {
            current_description = raw_data[current_id].links;

            let ul = `<ul style="list-style-type:none;padding:0;margin:0">${current_description.map(data =>
            `<li>${data}</li>`).join('')}
                  </ul>`;
            document.getElementById("description_content").innerHTML = ul;
        }
    }

    function showLinkedNodes() {
        document.getElementById("description_content").textContent = "WIP";
    }


    function toFrench() {
        mode = "french";
        document.getElementById("french_button").textContent = "Français";
        document.getElementById("english_button").textContent = "Anglais";

        document.getElementById("vulgarized_button").textContent = "Vulgarisé";
        document.getElementById("definition_button").textContent = "Définition";
        document.getElementById("details_button").textContent = "Détails";
        document.getElementById("links_button").textContent = "Liens";
        document.getElementById("linked_nodes_button").textContent = "Lié à...";

        if(current_description != null && 'french' in current_description && typeof current_description != 'string') {
            document.getElementById("description_content").textContent = current_description.french;
        }

        nodes_dataset.forEach(frenchForEach);

        function frenchForEach(item) {
            var id = ids.indexOf(item.id);
            network_data.nodes.update({"id":raw_data[id].id, "label":raw_data[id].label.french});
        }
    }

    function toEnglish() {
        mode = "english";
        document.getElementById("french_button").textContent = "French";
        document.getElementById("english_button").textContent = "English";

        document.getElementById("vulgarized_button").textContent = "Vulgarized";
        document.getElementById("definition_button").textContent = "Definition";
        document.getElementById("details_button").textContent = "Details";
        document.getElementById("links_button").textContent = "Links";
        document.getElementById("linked_nodes_button").textContent = "Connected to...";

        if(current_description != null && 'english' in current_description  && typeof current_description != 'string') {
            document.getElementById("description_content").textContent = current_description.english;
        }

        nodes_dataset.forEach(englishForEach);

        function englishForEach(item) {
            var id = ids.indexOf(item.id);
            network_data.nodes.update({"id":raw_data[id].id, "label":raw_data[id].label.english});
        }
    }

    fetch('all_nodes.json')
    .then(response => response.json())
    .then(data => {
        const filesList = data.files;
        const fetchPromises = filesList.map(fileName => {
            return fetch(fileName)
            .then(response => response.json())
            .then(fileData => {
                if (!Array.isArray(raw_data)) {
                    raw_data = [];
                }
                if (!Array.isArray(nodes)) {
                    nodes = [];
                }
                if (!Array.isArray(edges)) {
                    edges = [];
                }
                if (!Array.isArray(ids)) {
                    ids = [];
                }
                raw_data.push(fileData);
                nodes.push({id: fileData.id, label: fileData.label.english});
                ids.push(fileData.id);
                for (let edge_data of fileData.edge_to) {
                    edges.push({from: fileData.id,
                                to: edge_data,
                                arrows: {
                                    to: {
                                        enabled: true,
                                        type: "arrow",
                                    },
                                }
                    });
                }
            });
        });
        return Promise.all(fetchPromises);
    })
    .then(() => {
        nodes_dataset = new vis.DataSet(nodes);
        edges_dataset = new vis.DataSet(edges);

        var container = document.getElementById("mynetwork");
        network_data = {
          nodes: nodes_dataset,
          edges: edges_dataset,
        };

        var options = {};
        network = new vis.Network(container, network_data, options);

        network.on("click", function(clickProperties) {
            if(clickProperties.nodes.length == 1) {
                var id = ids.indexOf(clickProperties.nodes[0]);

                setDescription(id);
            } else if(clickProperties.nodes.length == 0) {
                document.getElementById("description").style.display = 'none';
                current_description = null;
            }
        });
    });

</script>
</body>
</html>